---

- name: create ceph user
  command: 'ceph auth get-or-create client.{{ ceph_user }} {{ ceph_rights }}'
  register: ceph_auth
  delegate_to: "{{ ceph_monitors[0] }}"
  run_once: True
  when: ceph_key == ''

- name: ensure /etc/ceph exists
  file: path=/etc/ceph state=directory owner=root group=root mode=0755

- name: generate ceph config file
  ini_file: dest=/etc/ceph/ceph.conf
    section=global
    option="{{ item.key }}"
    value="{{ item.value }}"
  with_dict:
    { "mon host": "{% for host in ceph_monitors %}{% if host in hostvars %}{{ hostvars[host].ip.mgmt }}{% else %}{{ host }}{% endif %}{% if not loop.last %},{% endif %}{% endfor %}",
      "auth cluster required": "cephx",
      "auth service required": "cephx",
      "auth client required": "cephx",
      "cephx require signatures": "true"
   }

- name: set default rbd features
  ini_file: dest=/etc/ceph/ceph.conf
    section=global
    option="rbd default features"
    value="{{ ceph_rbd_default_features }}"
  when: ceph_rbd_default_features

- name: write out ceph keyring (created key)
  copy: content='{{ ceph_auth.stdout }}\n' dest=/etc/ceph/ceph.client.{{ ceph_user}}.keyring
        owner={{ ceph_keyring_owner | default('root') }} group={{ ceph_keyring_group | default('root') }} mode=0440
  when: ceph_keyring_owner is defined and ceph_key == ''

- name: write out ceph keyring (predefined key)
  copy: content="[client.{{ ceph_user }}]\n\tkey = {{ ceph_key }}\n"
        dest=/etc/ceph/ceph.client.{{ ceph_user}}.keyring
        owner={{ ceph_keyring_owner | default('root') }} group={{ ceph_keyring_group | default('root') }} mode=0440
  when: ceph_keyring_owner is defined and ceph_key != ''
